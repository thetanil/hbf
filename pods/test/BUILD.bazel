# SPDX-License-Identifier: MIT
# Test pod - SQLite database with SQLAR archive + asset packing

# Pack assets using asset_packer
genrule(
    name = "packed_assets",
    srcs = glob(
        ["hbf/**/*", "static/**/*"],
        exclude = ["BUILD.bazel"],
        exclude_directories = 1,
    ) + [
        "@htmx//file",
        "//third_party/find-my-way:router",
    ],
    outs = [
        "assets_blob.c",
        "assets_blob.h",
    ],
    cmd = """
        # Create staging directory structure
        mkdir -p staging/hbf staging/static/vendor

        # Copy local hbf/ files using glob patterns
        for src in $(SRCS); do
            # Match files starting with 'pods/test/hbf/' (local files)
            if [[ $$src == pods/test/hbf/* ]]; then
                # Extract everything after 'pods/test/hbf/'
                rel_path=$${src#pods/test/hbf/}
                mkdir -p staging/hbf/$$(dirname $$rel_path)
                cp $$src staging/hbf/$$rel_path
            fi
        done

        # Copy all globbed static files
        for src in $(SRCS); do
            # Match files starting with 'pods/test/static/' (local files)
            if [[ $$src == pods/test/static/* ]]; then
                # Extract everything after 'pods/test/static/'
                rel_path=$${src#pods/test/static/}
                mkdir -p staging/static/$$(dirname $$rel_path)
                cp $$src staging/static/$$rel_path
            fi
        done

        # Stage HTMX
        cp $(location @htmx//file) staging/static/vendor/htmx.min.js

        # Stage find-my-way router
        mkdir -p staging/hbf/lib
        cp $(location //third_party/find-my-way:router) staging/hbf/lib/find-my-way.js

        # Collect all files for packing (sorted for determinism)
        cd staging
        find hbf static -type f | sort > ../files.txt
        cd ..

        # Run asset_packer with full paths from staging directory
        $(location //tools:asset_packer) \
            --output-source $(location assets_blob.c) \
            --output-header $(location assets_blob.h) \
            --symbol-name assets_blob \
            $$(sed 's|^|staging/|' files.txt)

        rm -rf staging files.txt
    """,
    tools = ["//tools:asset_packer"],
    visibility = ["//visibility:public"],
)

# Embedded assets library
cc_library(
    name = "embedded_assets",
    srcs = ["assets_blob.c"],
    hdrs = ["assets_blob.h"],
    visibility = ["//visibility:public"],
    alwayslink = True,  # Ensure symbols are included even if not directly referenced
)

# Build SQLite database with SQLAR archive of pod content
genrule(
    name = "pod_db",
    srcs = glob(
        ["hbf/**/*", "static/**/*"],
        exclude = ["BUILD.bazel"],
        exclude_directories = 1,
    ) + [
        "@htmx//file",
        "//hbf/db:overlay_schema.sql",
        "//third_party/find-my-way:router",
    ],
    outs = ["test.db"],
    cmd = """
        # Create staging directory structure
        mkdir -p staging/hbf staging/static/vendor

        # Copy local hbf/ files using glob patterns
        for src in $(SRCS); do
            # Match files starting with 'pods/test/hbf/' (local files)
            if [[ $$src == pods/test/hbf/* ]]; then
                # Extract everything after 'pods/test/hbf/'
                rel_path=$${src#pods/test/hbf/}
                mkdir -p staging/hbf/$$(dirname $$rel_path)
                cp $$src staging/hbf/$$rel_path
            fi
        done

        # Copy all globbed static files
        for src in $(SRCS); do
            # Match files starting with 'pods/test/static/' (local files)
            if [[ $$src == pods/test/static/* ]]; then
                # Extract everything after 'pods/test/static/'
                rel_path=$${src#pods/test/static/}
                mkdir -p staging/static/$$(dirname $$rel_path)
                cp $$src staging/static/$$rel_path
            fi
        done

        # Stage HTMX
        cp $(location @htmx//file) staging/static/vendor/htmx.min.js

        # Stage find-my-way router
        mkdir -p staging/hbf/lib
        cp $(location //third_party/find-my-way:router) staging/hbf/lib/find-my-way.js

        # Create SQLAR archive
        cd staging && sqlite3 -A -cf ../temp.db hbf static
        cd ..

        # Apply overlay schema at build time
        sqlite3 temp.db < $(location //hbf/db:overlay_schema.sql)

        # VACUUM to remove dead space and optimize database size
        sqlite3 temp.db "VACUUM INTO '$(location test.db)'"

        # Cleanup
        rm -rf staging temp.db
    """,
    visibility = ["//visibility:public"],
)

# Test that the pod database was created correctly
sh_test(
    name = "fs_build_test",
    srcs = ["fs_build_test.sh"],
    args = ["$(location :pod_db)"],
    data = [":pod_db"],
)
