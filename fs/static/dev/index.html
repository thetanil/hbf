<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBF Dev Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #1e1e1e;
            color: #cccccc;
        }

        #toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #2d2d2d;
            border-bottom: 1px solid #454545;
            flex-shrink: 0;
        }

        #toolbar h1 {
            font-size: 16px;
            font-weight: 600;
            margin-right: auto;
        }

        #toolbar input[type="text"] {
            flex: 1;
            max-width: 400px;
            padding: 6px 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #cccccc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        #toolbar button {
            padding: 6px 14px;
            background: #0e639c;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.15s;
        }

        #toolbar button:hover {
            background: #1177bb;
        }

        #toolbar button:active {
            background: #0d5a8f;
        }

        #toolbar button.secondary {
            background: #505050;
        }

        #toolbar button.secondary:hover {
            background: #606060;
        }

        #status {
            padding: 4px 10px;
            background: #3c3c3c;
            border-radius: 3px;
            font-size: 12px;
            min-width: 150px;
            text-align: center;
        }

        #status.success {
            background: #1e7b34;
            color: white;
        }

        #status.error {
            background: #d32f2f;
            color: white;
        }

        #container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        #sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #454545;
            overflow-y: auto;
            flex-shrink: 0;
        }

        #sidebar h3 {
            padding: 12px 15px;
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            font-weight: 600;
            border-bottom: 1px solid #3c3c3c;
        }

        #fileList {
            list-style: none;
        }

        #fileList li {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'Consolas', 'Monaco', monospace;
            border-bottom: 1px solid #2d2d2d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #fileList li:hover {
            background: #2a2d2e;
        }

        #fileList li.active {
            background: #094771;
            color: white;
        }

        #editorPane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #editor {
            flex: 1;
            min-height: 0;
        }

        #previewPane {
            width: 50%;
            border-left: 1px solid #454545;
            background: white;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #previewToolbar {
            padding: 8px 12px;
            background: #f3f3f3;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #preview {
            flex: 1;
            border: none;
            background: white;
        }

        .loading {
            opacity: 0.6;
        }

        /* Hide preview for non-HTML/CSS files */
        body.no-preview #previewPane {
            display: none;
        }

        body.no-preview #editorPane {
            flex: 1;
        }
    </style>
    <script src="/static/monaco/vs/loader.js"></script>
</head>
<body class="no-preview">
    <div id="toolbar">
        <h1>HBF Dev Editor</h1>
        <input type="text" id="fileName" placeholder="Select a file from the sidebar..." readonly />
        <button id="loadBtn" onclick="loadFile()">Reload</button>
        <button id="saveBtn" onclick="saveFile()">Save</button>
        <button class="secondary" id="newFileBtn" onclick="showNewFileDialog()">New File</button>
        <span id="status"></span>
    </div>

    <div id="container">
        <div id="sidebar">
            <h3>Files</h3>
            <ul id="fileList"></ul>
        </div>

        <div id="editorPane">
            <div id="editor"></div>
        </div>

        <div id="previewPane">
            <div id="previewToolbar">
                <span>Preview</span>
                <button onclick="reloadPreview()" style="padding: 4px 8px; background: #0e639c; border: none; color: white; border-radius: 2px; cursor: pointer; font-size: 11px;">Refresh</button>
            </div>
            <iframe id="preview" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let editor;
        let currentFile = null;
        let files = [];

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': '/static/monaco/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '// Select a file from the sidebar to start editing',
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 13,
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                wordWrap: 'on'
            });

            // Auto-save on Ctrl+S
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                saveFile();
            });

            // Load file list on startup
            loadFileList();
        });

        // Detect language from file extension
        function detectLanguage(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const langMap = {
                'js': 'javascript',
                'json': 'json',
                'html': 'html',
                'css': 'css',
                'md': 'markdown',
                'txt': 'plaintext',
                'sql': 'sql',
                'sh': 'shell',
                'py': 'python',
                'c': 'c',
                'h': 'c',
                'cpp': 'cpp',
                'ts': 'typescript'
            };
            return langMap[ext] || 'plaintext';
        }

        // Should show preview?
        function shouldShowPreview(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            return ext === 'html' || ext === 'htm';
        }

        // Load file list
        async function loadFileList() {
            try {
                setStatus('Loading files...', '');
                const response = await fetch('/__dev/api/files');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                files = await response.json();

                // Filter to only editable files (hbf/ and static/)
                files = files.filter(f =>
                    (f.name.startsWith('hbf/') || f.name.startsWith('static/')) &&
                    f.sz > 0 && // Exclude directories (sz=0)
                    !f.name.includes('/monaco/') && // Exclude Monaco files
                    !f.name.includes('/vendor/') // Exclude vendor files
                );

                renderFileList();
                setStatus(`${files.length} files`, 'success');
            } catch (err) {
                setStatus('Failed to load files: ' + err.message, 'error');
                console.error(err);
            }
        }

        // Render file list in sidebar
        function renderFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';

            files.forEach(file => {
                const li = document.createElement('li');
                li.textContent = file.name;
                li.title = file.name;
                li.onclick = () => selectFile(file.name);
                if (currentFile === file.name) {
                    li.classList.add('active');
                }
                list.appendChild(li);
            });
        }

        // Select a file from list
        function selectFile(fileName) {
            currentFile = fileName;
            document.getElementById('fileName').value = fileName;
            renderFileList();
            loadFile();
        }

        // Load file content
        async function loadFile() {
            if (!currentFile) {
                setStatus('No file selected', 'error');
                return;
            }

            try {
                setStatus('Loading...', '');
                const response = await fetch(`/__dev/api/file?name=${encodeURIComponent(currentFile)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();
                const language = detectLanguage(currentFile);

                monaco.editor.setModelLanguage(editor.getModel(), language);
                editor.setValue(content);

                setStatus(`Loaded: ${currentFile}`, 'success');

                // Show/hide preview pane
                if (shouldShowPreview(currentFile)) {
                    document.body.classList.remove('no-preview');
                    reloadPreview();
                } else {
                    document.body.classList.add('no-preview');
                }
            } catch (err) {
                setStatus('Load failed: ' + err.message, 'error');
                console.error(err);
            }
        }

        // Save file content
        async function saveFile() {
            if (!currentFile) {
                setStatus('No file selected', 'error');
                return;
            }

            try {
                setStatus('Saving...', '');
                const content = editor.getValue();

                const response = await fetch(
                    `/__dev/api/file?name=${encodeURIComponent(currentFile)}`,
                    {
                        method: 'PUT',
                        body: content
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                setStatus(`Saved: ${currentFile}`, 'success');

                // Auto-reload preview if visible
                if (shouldShowPreview(currentFile)) {
                    setTimeout(reloadPreview, 100);
                }
            } catch (err) {
                setStatus('Save failed: ' + err.message, 'error');
                console.error(err);
            }
        }

        // Reload preview iframe
        function reloadPreview() {
            if (!currentFile) return;

            const iframe = document.getElementById('preview');
            const previewPath = '/' + currentFile.replace(/^static\//, '');

            // Force reload by adding timestamp
            iframe.src = previewPath + '?t=' + Date.now();
        }

        // Show new file dialog
        function showNewFileDialog() {
            const fileName = prompt('Enter new file name (must start with static/ or hbf/):', 'static/new-file.txt');
            if (!fileName) return;

            if (!fileName.startsWith('static/') && !fileName.startsWith('hbf/')) {
                alert('File name must start with static/ or hbf/');
                return;
            }

            currentFile = fileName;
            document.getElementById('fileName').value = fileName;
            editor.setValue('');
            setStatus('New file: ' + fileName, 'success');

            // Add to file list if not exists
            if (!files.find(f => f.name === fileName)) {
                files.push({ name: fileName, mtime: 0, sz: 0 });
                renderFileList();
            }
        }

        // Set status message
        function setStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        // Auto-load on startup (after short delay for Monaco to initialize)
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Auto-select server.js if available
                const serverJs = files.find(f => f.name === 'hbf/server.js');
                if (serverJs) {
                    selectFile('hbf/server.js');
                }
            }, 500);
        });
    </script>
</body>
</html>
