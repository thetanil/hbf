# HBF Bazel configuration
# Enforces C99 compliance, warnings as errors, and optimization settings

# Enable bzlmod
common --enable_bzlmod

# C99 strict compilation with all warnings as errors
# NOTE: This project is C99 only - no C++ code or flags
build --conlyopt=-std=c99
build --conlyopt=-Wall
build --conlyopt=-Wextra
build --conlyopt=-Werror
build --conlyopt=-Wpedantic
build --conlyopt=-Wconversion
build --conlyopt=-Wdouble-promotion
build --conlyopt=-Wshadow
build --conlyopt=-Wformat=2
build --conlyopt=-Wstrict-prototypes
build --conlyopt=-Wold-style-definition
build --conlyopt=-Wmissing-prototypes
build --conlyopt=-Wmissing-declarations
build --conlyopt=-Wcast-qual
build --conlyopt=-Wwrite-strings
build --conlyopt=-Wcast-align
build --conlyopt=-Wundef
build --conlyopt=-Wswitch-enum
build --conlyopt=-Wswitch-default
build --conlyopt=-Wbad-function-cast

# Disable strict warnings for external dependencies (sqlite3, etc.)
build --per_file_copt=external/.*@-Wno-conversion,-Wno-sign-conversion,-Wno-cast-qual,-Wno-undef,-Wno-bad-function-cast,-Wno-error

# Optimization and binary size reduction
build --conlyopt=-O2
build --conlyopt=-fdata-sections
build --conlyopt=-ffunction-sections

# POSIX features for C99
build --conlyopt=-D_POSIX_C_SOURCE=200809L
build --copt=-D_POSIX_C_SOURCE=200809L

# SQLite compile-time options
build --copt=-DSQLITE_THREADSAFE=1
build --copt=-DSQLITE_ENABLE_FTS5
build --copt=-DSQLITE_ENABLE_SQLAR
build --copt=-DSQLITE_OMIT_LOAD_EXTENSION
build --copt=-DSQLITE_DEFAULT_WAL_SYNCHRONOUS=1
build --copt=-DSQLITE_ENABLE_JSON1

# Static linking with musl toolchain
# NOTE: Using musl static linking. Binary has ZERO runtime dependencies.
# Musl toolchain configured in MODULE.bazel via toolchains_musl v0.1.27
build --linkopt=-static
build --linkopt=-Wl,--gc-sections
# Note: Stripping is done via genrule in root BUILD.bazel

# Platform-specific settings (kept for compatibility)
build:linux --copt=-D_GNU_SOURCE

# Development mode (unstripped debug build)
build:dev --compilation_mode=dbg
build:dev --conlyopt=-O0
build:dev --conlyopt=-g

# Debug mode (for CI - unstripped symbols build)
build:debug --compilation_mode=dbg

# Release mode (for CI - stripped optimized build)
build:release --compilation_mode=opt
build:release --conlyopt=-O3
build:release --linkopt=-s
build:release --strip=always

# Test configuration
test --test_output=errors
test --test_summary=detailed
test --test_verbose_timeout_warnings

# Performance optimizations
build --jobs=auto
# Note: Removed explicit resource limits to allow Bazel to auto-detect available resources.
# This is especially important for CI where GitHub Actions runners have 7GB RAM available.
# For local development with constrained resources, add limits to ~/.bazelrc.user (not checked into git).

# Color output
common --color=yes

# Show detailed errors
build --verbose_failures

# Cache settings
build --disk_cache=~/.cache/bazel

# Strict mode: error on analysis cache discard (useful for local development)
# This prevents accidental flag changes that would slow down builds.
# Not enabled by default because CI needs to build both release and debug.
# Usage: bazel build --config=strict //:hbf
build:strict --noallow_analysis_cache_discard

# Note: Use named configs (--config=release, --config=debug, --config=dev) to
# minimize cache invalidation. For personal strict enforcement during development,
# add "build --noallow_analysis_cache_discard" to ~/.bazelrc.user (not checked into git).
